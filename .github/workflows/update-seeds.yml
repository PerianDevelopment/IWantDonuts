name: Update Seeds

on:
  workflow_dispatch:       # only manual trigger

permissions:
  contents: write

jobs:
  update-seeds:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set timezone to Europe/Berlin
        run: |
          sudo timedatectl set-timezone Europe/Berlin

      - name: Generate seeds
        id: seeds
        env:
          SEED_SECRET: ${{ secrets.SEED_SECRET }}
        run: |
          # New daily seed (A-Z + 0-9, salted with secret)
          DAILY=$(echo "${SEED_SECRET}$(openssl rand -base64 32)" \
            | sha256sum | base64 | tr -dc 'A-Z0-9' | head -c10)

          # Only generate a new monthly seed if it's the 1st
          DAY=$(date +%d)
          if [ "$DAY" -eq "01" ]; then
            MONTHLY=$(echo "${SEED_SECRET}$(openssl rand -base64 32)" \
              | sha256sum | base64 | tr -dc 'A-Z0-9' | head -c10)
          else
            # reuse last monthly seed
            if [ -f docs/seeds.json ]; then
              MONTHLY=$(jq -r '.monthly' docs/seeds.json)
            else
              MONTHLY=$(echo "${SEED_SECRET}$(openssl rand -base64 32)" \
                | sha256sum | base64 | tr -dc 'A-Z0-9' | head -c10)
            fi
          fi

          echo "daily=$DAILY" >> $GITHUB_OUTPUT
          echo "monthly=$MONTHLY" >> $GITHUB_OUTPUT

      - name: Save seeds.json into docs
        run: |
          mkdir -p docs
          echo "{
            \"daily\": \"${{ steps.seeds.outputs.daily }}\",
            \"monthly\": \"${{ steps.seeds.outputs.monthly }}\"
          }" > docs/seeds.json

      - name: Update daily_history.json
        run: |
          TODAY=$(date +%Y-%m-%d)
          DAILY_ENTRY="{\"date\": \"${TODAY}\", \"seed\": \"${{ steps.seeds.outputs.daily }}\"}"

          if [ -f daily_history.json ]; then
            # only add if today isn't already in file
            if ! jq -e ".[] | select(.date == \"${TODAY}\")" daily_history.json > /dev/null; then
              jq ". + [${DAILY_ENTRY}]" daily_history.json > tmp.json
              mv tmp.json daily_history.json
            fi
          else
            echo "[${DAILY_ENTRY}]" > daily_history.json
          fi

      - name: Update monthly_history.json
        run: |
          MONTH=$(date +%Y-%m)
          MONTHLY_ENTRY="{\"month\": \"${MONTH}\", \"seed\": \"${{ steps.seeds.outputs.monthly }}\"}"

          if [ -f monthly_history.json ]; then
            # only add if this month isn't already in file
            if ! jq -e ".[] | select(.month == \"${MONTH}\")" monthly_history.json > /dev/null; then
              jq ". + [${MONTHLY_ENTRY}]" monthly_history.json > tmp.json
              mv tmp.json monthly_history.json
            fi
          else
            echo "[${MONTHLY_ENTRY}]" > monthly_history.json
          fi

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/seeds.json daily_history.json monthly_history.json
          git commit -m "Update seeds [skip ci]" || exit 0
          git push
